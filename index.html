<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pelacak Perangkat — Share Link</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h1 class="text-2xl font-bold">Pelacak Perangkat — Bagikan Link</h1>
      <p class="text-sm text-gray-600">Perangkat pembuat session (Tracker) membuat link dan membagikannya. Perangkat penerima membuka link lalu mengaktifkan "Share Location". Tracker tidak perlu mengaktifkan lokasi.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Map & list -->
      <div class="lg:col-span-2 space-y-4">
        <div id="map" class="w-full h-96 rounded shadow-lg bg-gray-100"></div>

        <div class="bg-white rounded shadow p-4">
          <h2 class="font-semibold text-lg">Perangkat Aktif</h2>
          <ul id="devicesList" class="mt-3 space-y-2 text-sm text-gray-700">
            <li class="text-gray-500">Belum ada lokasi diterima</li>
          </ul>
        </div>
      </div>

      <!-- Controls -->
      <div class="space-y-4">
        <div class="bg-white rounded shadow p-4">
          <h2 class="font-semibold">Tracker (Buat & tunggu)</h2>
          <div class="mt-2 space-y-2">
            <input id="trackerName" class="w-full p-2 border rounded" placeholder="Nama Anda (opsional)" />
            <button id="createSessionBtn" class="w-full py-2 bg-indigo-600 text-white rounded">Buat Session & Dapatkan Link</button>
            <input id="shareLink" class="w-full p-2 border rounded bg-gray-50 mt-2" readonly />
            <button id="startListenBtn" class="w-full py-2 bg-green-600 text-white rounded mt-2" disabled>Dengarkan Lokasi (Mulai)</button>
            <button id="stopListenBtn" class="w-full py-2 bg-red-600 text-white rounded mt-2" disabled>Hentikan Mendengarkan</button>
          </div>
        </div>

        <div class="bg-white rounded shadow p-4">
          <h2 class="font-semibold">Target (Buka link yang dibagikan)</h2>
          <div id="targetBox" class="mt-2 space-y-2">
            <div id="targetInfo" class="text-sm text-gray-700">Tidak dalam mode share.</div>
            <input id="targetName" class="w-full p-2 border rounded hidden" placeholder="Nama perangkat (opsional)" />
            <div id="targetButtons" class="space-y-2 hidden">
              <button id="startShareBtn" class="w-full py-2 bg-green-600 text-white rounded">Mulai Bagikan Lokasi</button>
              <button id="stopShareBtn" disabled class="w-full py-2 bg-red-600 text-white rounded">Berhenti Bagikan</button>
            </div>
          </div>
        </div>

        <div class="bg-white rounded shadow p-4 text-xs text-gray-600">
          <strong>Catatan singkat:</strong>
          <ol class="list-decimal list-inside mt-2">
            <li>Tracker: Klik "Buat Session" lalu salin link dan bagikan ke target.</li>
            <li>Target: Buka link → klik "Mulai Bagikan Lokasi" → izinkan akses lokasi.</li>
            <li>Lokasi dikirim ke Firebase Realtime Database; tracker menerima pembaruan real-time.</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase Realtime Database (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ====== KONFIGURASI ======
    // Buat project Firebase dan Realtime Database. Ganti nilai di bawah dengan config project Anda.
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    // =================================

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ====== Inisialisasi peta ======
    const map = L.map('map').setView([-6.2,106.8], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markers = {}; // sessionId -> marker

    // ====== Util ======
    const makeId = (n=8) => Math.random().toString(36).slice(2, 2+n);
    const params = new URLSearchParams(window.location.search);
    const shareParam = params.get('share'); // jika ada, ini adalah target yang diminta untuk share ke session

    // ====== UI elemen ======
    const createSessionBtn = document.getElementById('createSessionBtn');
    const shareLinkInput = document.getElementById('shareLink');
    const startListenBtn = document.getElementById('startListenBtn');
    const stopListenBtn = document.getElementById('stopListenBtn');
    const devicesList = document.getElementById('devicesList');
    const trackerNameInput = document.getElementById('trackerName');

    const targetBox = document.getElementById('targetBox');
    const targetInfo = document.getElementById('targetInfo');
    const targetNameInput = document.getElementById('targetName');
    const targetButtons = document.getElementById('targetButtons');
    const startShareBtn = document.getElementById('startShareBtn');
    const stopShareBtn = document.getElementById('stopShareBtn');

    // ====== State ======
    let currentSession = null; // session id yang dibuat (di tracker)
    let listenRef = null; // firebase listener ref untuk tracker
    let watchId = null; // geolocation watch id (di target)

    // ====== Tracker: buat session & dengarkan lokasi ======
    createSessionBtn.addEventListener('click', () => {
      const sid = 'sess_' + makeId(10);
      currentSession = sid;
      // simpan meta (opsional)
      const meta = { createdAt: Date.now(), trackerName: trackerNameInput.value || 'Tracker' };
      db.ref('sessions/' + sid + '/meta').set(meta);
      const url = location.origin + location.pathname + '?share=' + sid;
      shareLinkInput.value = url;
      startListenBtn.disabled = false;
      alert('Session dibuat. Bagikan link ke perangkat target.');
    });

    startListenBtn.addEventListener('click', () => {
      if (!currentSession) { alert('Buat session dulu'); return; }
      startListening(currentSession);
      startListenBtn.disabled = true;
      stopListenBtn.disabled = false;
    });

    stopListenBtn.addEventListener('click', () => {
      stopListening();
      startListenBtn.disabled = false;
      stopListenBtn.disabled = true;
    });

    function startListening(sessionId) {
      // listen pada path sessions/{sessionId}/location
      if (listenRef) listenRef.off();
      listenRef = db.ref('sessions/' + sessionId + '/location');
      listenRef.on('value', snapshot => {
        const val = snapshot.val();
        renderDevices(val, sessionId);
      });
      // juga listen status (optional)
      db.ref('sessions/' + sessionId + '/status').on('value', s => {
        const st = s.val();
        // bisa tampilkan status di UI (left as simple)
      });
    }

    function stopListening() {
      if (listenRef) {
        listenRef.off();
        listenRef = null;
      }
      devicesList.innerHTML = '<li class="text-gray-500 text-center py-4">Mendengarkan dihentikan</li>';
      // hapus marker untuk sesi ini
      if (currentSession && markers[currentSession]) {
        map.removeLayer(markers[currentSession]);
        delete markers[currentSession];
      }
    }

    function renderDevices(locObj, sessionId) {
      // locObj adalah object { lat, lng, accuracy, ts, name } dari target
      if (!locObj) {
        devicesList.innerHTML = '<li class="text-gray-500 text-center py-4">Belum ada lokasi diterima</li>';
        if (markers[sessionId]) { map.removeLayer(markers[sessionId]); delete markers[sessionId]; }
        return;
      }
      const name = locObj.name || 'Target';
      const lat = locObj.lat;
      const lng = locObj.lng;
      const acc = locObj.accuracy || 0;
      const ts = locObj.ts ? new Date(locObj.ts) : null;
      const age = ts ? Math.round((Date.now() - ts)/1000) : '-';

      devicesList.innerHTML = `
        <li class="bg-gray-50 p-3 rounded border-l-4 border-indigo-600">
          <div class="font-semibold text-indigo-700">${name}</div>
          <div class="text-xs text-gray-600">Lat: ${lat.toFixed(6)} — Lng: ${lng.toFixed(6)}</div>
          <div class="text-xs text-gray-500">Akurasi: ±${Math.round(acc)}m • ${age}s lalu</div>
          <div class="mt-2">
            <button class="px-2 py-1 bg-indigo-600 text-white text-xs rounded" onclick="focusOn(${lat}, ${lng})">Fokus</button>
            <button class="px-2 py-1 bg-red-500 text-white text-xs rounded ml-2" onclick="clearSession('${sessionId}')">Hapus Session</button>
          </div>
        </li>
      `;

      // update marker
      if (!markers[sessionId]) {
        markers[sessionId] = L.marker([lat, lng]).addTo(map).bindPopup(`<b>${name}</b><br>${ts ? ts.toLocaleString() : ''}`);
      } else {
        markers[sessionId].setLatLng([lat, lng]).setPopupContent(`<b>${name}</b><br>${ts ? ts.toLocaleString() : ''}`);
      }
      map.setView([lat, lng], 15);
    }

    // global helpers used by inline onclick
    window.focusOn = (lat,lng) => { map.setView([lat,lng],16); };
    window.clearSession = (sid) => {
      if (!confirm('Hapus data sesi ini dari database?')) return;
      db.ref('sessions/' + sid).remove();
      if (markers[sid]) { map.removeLayer(markers[sid]); delete markers[sid]; }
      devicesList.innerHTML = '<li class="text-gray-500 text-center py-4">Session dihapus</li>';
    };

    // ====== Target: jika membuka link ?share=SESSION_ID ======
    if (shareParam) {
      // tampilkan UI target
      targetInfo.textContent = 'Anda diminta membagikan lokasi ke session: ' + shareParam;
      targetNameInput.classList.remove('hidden');
      targetButtons.classList.remove('hidden');
      targetInfo.classList.add('text-sm');

      startShareBtn.addEventListener('click', () => {
        const name = (targetNameInput.value && targetNameInput.value.trim()) || ('Target_' + makeId(4));
        startSharing(shareParam, name);
      });

      stopShareBtn.addEventListener('click', () => {
        stopSharing(shareParam);
      });
    }

    function startSharing(sessionId, deviceName) {
      if (!navigator.geolocation) { alert('Geolocation tidak didukung'); return; }
      startShareBtn.disabled = true;
      stopShareBtn.disabled = false;
      targetInfo.textContent = 'Mengirim lokasi ke session: ' + sessionId;

      const locRef = db.ref('sessions/' + sessionId + '/location');
      const statusRef = db.ref('sessions/' + sessionId + '/status');

      // set online status and cleanup on disconnect
      statusRef.set({ sharing: true, name: deviceName, ts: Date.now() });
      statusRef.onDisconnect().set({ sharing: false, ts: Date.now() });

      // start watchPosition
      watchId = navigator.geolocation.watchPosition(pos => {
        const payload = {
          name: deviceName,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          ts: Date.now()
        };
        locRef.set(payload);
      }, err => {
        alert('Gagal membaca lokasi: ' + err.message);
        stopSharing(sessionId);
      }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });

      // also write lastSeen meta for convenience
      db.ref('sessions/' + sessionId + '/meta/target').set({ name: deviceName, startedAt: Date.now() });
      db.ref('sessions/' + sessionId + '/meta/target').onDisconnect().remove();
    }

    function stopSharing(sessionId) {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      // remove location & update status
      db.ref('sessions/' + sessionId + '/location').remove().catch(()=>{});
      db.ref('sessions/' + sessionId + '/status').set({ sharing: false, ts: Date.now() }).catch(()=>{});
      startShareBtn.disabled = false;
      stopShareBtn.disabled = true;
      targetInfo.textContent = 'Pengiriman lokasi dihentikan';
    }

    // ====== Cleanup on unload ======
    window.addEventListener('beforeunload', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }
      // jika tracker had listener, detach
      if (listenRef) listenRef.off();
    });
  </script>
</body>
</html>